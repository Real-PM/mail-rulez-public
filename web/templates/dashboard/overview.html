<!--
Mail-Rulez - Intelligent Email Management System
Copyright (c) 2024 Real Project Management Solutions
Dual-licensed software. See LICENSE-DUAL for details.
-->

{% extends "base.html" %}

{% block title %}Dashboard - {{ super() }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2"><i class="bi bi-speedometer2"></i> Dashboard</h1>
    </div>

    <!-- Service Mode Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="text-white-75 small">Service Mode</div>
                            <div class="h3 fw-bold mb-0">{{ service_info.mode }}</div>
                            <div class="small mt-2">{{ service_info.description }}</div>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-gear fs-1"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{{ url_for('accounts.list_accounts') }}">
                        {{ "Manage Accounts" if account_count > 0 else "Add Account" }}
                    </a>
                    <div class="small text-white"><i class="bi bi-angle-right"></i></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Processing Controls (Startup Mode Only) -->
    <div class="row mb-4" id="batch-processing-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-inbox"></i> Startup Mode - "No Overwhelm" Processing
                    <small class="text-muted ms-2">Manual control, 100 emails at a time</small>
                </div>
                <div class="card-body">
                    <div class="bg-light border border-info rounded p-3 mb-3">
                        <div class="d-flex align-items-start">
                            <i class="bi bi-info-circle text-info me-2 mt-1"></i>
                            <div>
                                <h6 class="text-info mb-2">Manual Processing Only</h6>
                                <p class="mb-0 text-muted">
                                    In startup mode, emails are only processed when you click the "Process Next 100" button.
                                    No automatic processing occurs - you have complete control over when and how many emails are processed.
                                    This prevents inbox overwhelm during initial setup.
                                </p>
                            </div>
                        </div>
                    </div>
                    <div id="batch-processing-accounts">
                        <!-- Dynamically populated per account -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Status Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-envelope"></i> Email Accounts
                </div>
                <div class="card-body">
                    {% if accounts and accounts|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Status</th>
                                    <th>Mode</th>
                                    <th>Last Run</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for account in accounts %}
                                <tr>
                                    <td>
                                        <strong>{{ account.email }}</strong><br>
                                        <small class="text-muted">{{ account.server }}</small>
                                    </td>
                                    <td>
                                        {% if account.status == 'running' %}
                                            <span class="badge bg-success">Running</span>
                                        {% elif account.status == 'stopped' %}
                                            <span class="badge bg-secondary">Stopped</span>
                                        {% elif account.status == 'error' %}
                                            <span class="badge bg-danger">Error</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ account.status|title }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if account.mode == 'startup' else 'primary' }}">
                                            {{ account.mode|title }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if account.last_run %}
                                            {{ account.last_run }}
                                        {% else %}
                                            <span class="text-muted">Never</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('accounts.edit_account', account_id=loop.index0) }}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> Edit
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-inbox display-1 text-muted"></i>
                        <p class="lead mt-3">No email accounts configured</p>
                        <a href="{{ url_for('accounts.add_account') }}" class="btn btn-primary">
                            <i class="bi bi-plus-circle"></i> Add Your First Account
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load batch processing controls on page load
document.addEventListener('DOMContentLoaded', function() {
    loadBatchProcessingControls();
});

async function loadBatchProcessingControls() {
    try {
        // Get system status to check for startup mode accounts (with timeout)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

        const response = await fetch('/api/services/status', {
            signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        if (!data.success || !data.data.accounts) {
            return;
        }

        // Find accounts in startup mode
        const startupAccounts = [];
        for (const [accountEmail, accountData] of Object.entries(data.data.accounts)) {
            if (accountData && accountData.mode === 'startup') {
                startupAccounts.push(accountEmail);
            }
        }

        if (startupAccounts.length === 0) {
            // No startup accounts, hide the section
            document.getElementById('batch-processing-section').style.display = 'none';
            return;
        }

        // Show the section and build controls
        document.getElementById('batch-processing-section').style.display = 'block';
        await buildBatchProcessingControls(startupAccounts);

    } catch (error) {
        console.error('Error loading batch processing controls:', error);
    }
}

async function buildBatchProcessingControls(accounts) {
    const container = document.getElementById('batch-processing-accounts');

    // Build UI immediately with loading indicators
    let html = '';
    for (const accountEmail of accounts) {
        const safeEmail = accountEmail.replace(/[^a-zA-Z0-9]/g, '_');
        html += `
            <div class="row mb-3 account-batch-control" data-account="${accountEmail}">
                <div class="col-md-6">
                    <h6>${accountEmail}</h6>
                    <small class="text-muted">
                        Inbox: <span class="inbox-count" id="inbox-count-${safeEmail}">Loading...</span> emails
                    </small>
                </div>
                <div class="col-md-6 text-end">
                    <div>
                        <button class="btn btn-primary btn-sm process-batch-btn"
                                data-account="${accountEmail}"
                                disabled
                                onclick="processBatch('${accountEmail}')">
                            <i class="bi bi-play-circle"></i> Process Next 100
                        </button>
                    </div>
                </div>
                <div class="progress mt-2" style="height: 5px;">
                    <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="batch-result mt-2" style="display: none;"></div>
            </div>
        `;
    }

    container.innerHTML = html;

    // Load inbox counts asynchronously in parallel
    const countPromises = accounts.map(async (accountEmail) => {
        const safeEmail = accountEmail.replace(/[^a-zA-Z0-9]/g, '_');
        const countSpan = document.getElementById(`inbox-count-${safeEmail}`);
        const button = document.querySelector(`button[data-account="${accountEmail}"]`);

        try {
            // Add timeout to inbox count request
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 second timeout for IMAP operations

            const countResponse = await fetch(`/api/services/accounts/${encodeURIComponent(accountEmail)}/inbox-count`, {
                signal: controller.signal
            });
            clearTimeout(timeoutId);

            const countData = await countResponse.json();
            if (countData.success) {
                const inboxCount = countData.data.inbox_count;
                countSpan.textContent = inboxCount;

                // Enable button if there are emails to process
                if (inboxCount > 0) {
                    button.disabled = false;
                } else {
                    button.innerHTML = '<i class="bi bi-check-circle"></i> Inbox Empty';
                }
            } else {
                throw new Error(countData.error || 'Failed to get inbox count');
            }
        } catch (error) {
            console.warn(`Could not get inbox count for ${accountEmail}:`, error);
            countSpan.textContent = 'Error';
            countSpan.className = 'inbox-count text-danger';
            button.disabled = false; // Allow user to try anyway
        }
    });

    // Wait for all counts to complete (but don't block the UI)
    Promise.allSettled(countPromises).then(() => {
        console.log('All inbox counts loaded');
    });
}

async function processBatch(accountEmail) {
    const controlDiv = document.querySelector(`[data-account="${accountEmail}"]`);
    const button = controlDiv.querySelector('.process-batch-btn');
    const progressBar = controlDiv.querySelector('.progress-bar');
    const resultDiv = controlDiv.querySelector('.batch-result');
    const inboxCountSpan = controlDiv.querySelector('.inbox-count');

    try {
        // Disable button and show progress
        button.disabled = true;
        button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        progressBar.style.width = '50%';
        progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
        resultDiv.style.display = 'none';

        // Make API call
        const response = await fetch(`/api/services/accounts/${encodeURIComponent(accountEmail)}/process-batch`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ limit: 100 })
        });

        const data = await response.json();

        if (data.success) {
            // Update progress bar
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
            progressBar.classList.add('bg-success');

            // Update inbox count based on emails pending
            inboxCountSpan.textContent = data.data.emails_pending;

            // Show results
            const result = data.data;
            const inboxResult = result.inbox_result || {};
            const categories = inboxResult.categories || {
                whitelisted: 0,
                blacklisted: 0,
                vendor: 0,
                pending: result.emails_pending || 0
            };

            resultDiv.innerHTML = `
                <div class="alert alert-success alert-sm">
                    <strong>Processed ${result.emails_processed} emails:</strong>
                    ${categories.whitelisted || 0} to Processed,
                    ${categories.blacklisted || 0} to Junk,
                    ${categories.vendor || 0} to Approved Ads,
                    ${categories.pending || 0} remaining in Pending
                </div>
            `;
            resultDiv.style.display = 'block';

            // Re-enable button if more emails remain
            if (result.emails_pending > 0) {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-play-circle"></i> Process Next 100';
            } else {
                button.innerHTML = '<i class="bi bi-check-circle"></i> Inbox Empty';
            }

        } else {
            throw new Error(data.error || 'Unknown error');
        }

    } catch (error) {
        console.error('Batch processing error:', error);

        // Show error state
        progressBar.style.width = '100%';
        progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
        progressBar.classList.add('bg-danger');

        resultDiv.innerHTML = `
            <div class="alert alert-danger alert-sm">
                <strong>Error:</strong> ${error.message || 'Processing failed'}
            </div>
        `;
        resultDiv.style.display = 'block';

        // Re-enable button
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-play-circle"></i> Process Next 100';
    }

    // Reset progress bar after a delay
    setTimeout(() => {
        progressBar.style.width = '0%';
        progressBar.classList.remove('bg-success', 'bg-danger');
    }, 3000);
}

// Add CSS for batch processing
const style = document.createElement('style');
style.textContent = `
    .alert-sm {
        padding: 0.375rem 0.75rem;
        margin-bottom: 0;
        font-size: 0.875rem;
    }
    .account-batch-control {
        border-left: 3px solid var(--bs-primary);
        padding-left: 1rem;
        background-color: rgba(var(--bs-primary-rgb), 0.05);
        border-radius: 0.375rem;
        padding: 1rem;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
